import streamlit as st
import pandas as pd
import plotly.express as px

# 1. í˜ì´ì§€ ì„¤ì •
st.set_page_config(page_title="ë¶€ì²œë°”ë¥¸ì •í˜•ì™¸ê³¼ ë¦¬í¬íŠ¸", layout="wide")
st.markdown('<h2 style="color: #0369a1;">ğŸ¥ ë¶€ì²œë°”ë¥¸ì •í˜•ì™¸ê³¼ ê²½ì˜ ë¶„ì„ ë¦¬í¬íŠ¸</h2>', unsafe_allow_html=True)

# 2. ì‚¬ì´ë“œë°” ì„¤ì •
with st.sidebar:
    st.header("ğŸ“‚ ë°ì´í„° ë¡œë“œ")
    f_rev = st.file_uploader("ğŸ’° 1. ë§¤ì¶œ ë°ì´í„°", type=["xlsx", "xls"], accept_multiple_files=True)
    st.markdown("---")
    files_all = st.file_uploader("ğŸ‘¥ 2. ì „ì²´ í™˜ì ëª…ë‹¨", type=["xlsx", "xls"], accept_multiple_files=True)
    files_new = st.file_uploader("ğŸ†• 3. ì´ˆì§„ í¬í•¨ ëª…ë‹¨", type=["xlsx", "xls"], accept_multiple_files=True)

def to_int(x):
    try:
        if pd.isna(x): return 0
        val = "".join(filter(str.isdigit, str(x)))
        return int(val) if val else 0
    except: return 0

# ğŸ¨ ì›ì¥ë‹˜ ì§€ì • íŒŒìŠ¤í…” ì»¬ëŸ¬ (4ì§„ë£Œì‹¤ ë…ë¦½ ìƒ‰ìƒ)
SOFT_PALETTE = ["#FFADAD", "#FDFFB6", "#CAFFBF", "#9BF6FF"]

if f_rev and files_all and files_new:
    try:
        def load_data(files, h):
            d_list = []
            for f in files:
                tdf = pd.read_excel(f, header=h)
                tdf.columns = [str(c).replace(' ', '').strip() for c in tdf.columns]
                d_list.append(tdf)
            return pd.concat(d_list).reset_index(drop=True) if d_list else None

        df_all = load_data(files_all, 1)
        df_new_raw = load_data(files_new, 2)
        
        # ğŸ—“ï¸ ë‚ ì§œ ì»¬ëŸ¼ ì¸ì‹ (mixed format ì ìš©ìœ¼ë¡œ ì˜¤ë¥˜ ì›ì²œ ì°¨ë‹¨)
        date_col = next((c for c in df_all.columns if any(k in c for k in ['ì¼', 'ë‚ ì§œ', 'Date'])), None)
        if date_col:
            df_all[date_col] = pd.to_datetime(df_all[date_col], errors='coerce', format='mixed')
            df_all = df_all.dropna(subset=[date_col])

        # --- [1. ë§¤ì¶œ ë°ì´í„° ì²˜ë¦¬] ---
        rev_data = {}
        for f in f_rev:
            name = f.name.split(' ')[0].strip()
            df_r = pd.read_excel(f, header=None)
            t_idx = df_r[df_r.apply(lambda r: r.astype(str).str.contains('í•©ê³„').any(), axis=1)].index[-1]
            row = df_r.iloc[t_idx]
            tot_rev = to_int(row[2]) + to_int(row[6])
            rev_data[name] = {
                "ì´ë§¤ì¶œ": tot_rev, "ê¸‰ì—¬": to_int(row[2]), "ë¹„ê¸‰ì—¬": to_int(row[6]),
                "ê°ë‹¨ê°€": int(tot_rev / to_int(row[9])) if to_int(row[9]) > 0 else 0
            }

        # --- [2. ì¬ì§„ìœ¨ ê³„ì‚° (30ì¼ ì¬ë°©ë¬¸ ë¡œì§)] ---
        target_rooms = ['1ì§„ë£Œì‹¤', '2ì§„ë£Œì‹¤', '3ì§„ë£Œì‹¤', '4ì§„ë£Œì‹¤']
        summary_list = []
        for room in target_rooms:
            r_all = df_all[df_all['ì§„ë£Œì‹¤'] == room]
            r_new = df_new_raw[(df_new_raw['ì§„ë£Œì‹¤'] == room) & (df_new_raw['ì‹ ê·œí™˜ì'].astype(str).str.contains("ì‹ ê·œ", na=False))]
            new_names = r_new['ìˆ˜ì§„ìëª…'].unique()
            revisit_count = 0
            if date_col:
                for name in new_names:
                    p_visits = r_all[r_all['ìˆ˜ì§„ìëª…'] == name].sort_values(date_col)
                    if len(p_visits) > 1:
                        diff = (p_visits.iloc[1][date_col] - p_visits.iloc[0][date_col]).days
                        if 0 < diff <= 30: revisit_count += 1
            m = rev_data.get(room, {"ì´ë§¤ì¶œ":0, "ê¸‰ì—¬":0, "ë¹„ê¸‰ì—¬":0, "ê°ë‹¨ê°€":0})
            summary_list.append({
                "ì§„ë£Œì‹¤": room, "ì´ë§¤ì¶œ": m["ì´ë§¤ì¶œ"], "ê¸‰ì—¬": m["ê¸‰ì—¬"], "ë¹„ê¸‰ì—¬": m["ë¹„ê¸‰ì—¬"], "ê°ë‹¨ê°€": m["ê°ë‹¨ê°€"],
                "ì „ì²´ë‚´ì›(ê±´)": len(r_all), "ì‹ ê·œí™˜ì(ëª…)": len(r_new), "ì‹ ê·œì¬ë°©ë¬¸(ëª…)": revisit_count,
                "ì‹ í™˜ ì¬ë°©ë¬¸ìœ¨(%)": round(revisit_count / len(r_new) * 100, 1) if len(r_new) > 0 else 0,
                "ì „ì²´ ëŒ€ë¹„ ê¸°ì—¬ë„(%)": round(revisit_count / len(r_all) * 100, 1) if len(r_all) > 0 else 0
            })
        df_final = pd.DataFrame(summary_list)

        # --- [ì„¹ì…˜ A: ë§¤ì¶œ ë¶„ì„ - ê¸°ì¡´ ìœ ì§€ + ì‹ ê·œ ê·¸ë˜í”„] ---
        st.write("### ğŸ’° ì§„ë£Œì‹¤ë³„ ë§¤ì¶œ ë° ê°ë‹¨ê°€ í†µê³„")
        st.table(df_final[['ì§„ë£Œì‹¤', 'ì´ë§¤ì¶œ', 'ê¸‰ì—¬', 'ë¹„ê¸‰ì—¬', 'ê°ë‹¨ê°€']].set_index('ì§„ë£Œì‹¤').style.format("{:,}ì›"))
        
        m_c1, m_c2 = st.columns(2)
        with m_c1:
            fig1 = px.bar(df_final, x='ì§„ë£Œì‹¤', y='ì´ë§¤ì¶œ', color='ì§„ë£Œì‹¤', color_discrete_sequence=SOFT_PALETTE, title="ì§„ë£Œì‹¤ë³„ ì´ë§¤ì¶œ")
            fig1.update_layout(yaxis_tickformat=',d', showlegend=False)
            st.plotly_chart(fig1, use_container_width=True)
        with m_c2:
            fig2 = px.bar(df_final, x='ì§„ë£Œì‹¤', y='ê°ë‹¨ê°€', color='ì§„ë£Œì‹¤', color_discrete_sequence=SOFT_PALETTE, title="ì§„ë£Œì‹¤ë³„ ê°ë‹¨ê°€")
            fig2.update_layout(yaxis_tickformat=',d', showlegend=False)
            st.plotly_chart(fig2, use_container_width=True)

        # â­ [ì‹ ê·œ ì¶”ê°€] ê¸‰ì—¬/ë¹„ê¸‰ì—¬ ë§¤ì¶œ ë¹„ì¤‘ ê·¸ë˜í”„
        st.write("#### ğŸ“Š ì§„ë£Œì‹¤ë³„ ê¸‰ì—¬/ë¹„ê¸‰ì—¬ ì‹¤ì  êµ¬ì„±ë¹„")
        fig_ratio = px.bar(df_final, y='ì§„ë£Œì‹¤', x=['ê¸‰ì—¬', 'ë¹„ê¸‰ì—¬'], 
                           orientation='h', barmode='relative',
                           color_discrete_sequence=["#A2D2FF", "#FFCCAC"], # ê¸‰ì—¬:ì—°íŒŒë‘, ë¹„ê¸‰ì—¬:ì—°ì£¼í™©
                           title="ì§„ë£Œì‹¤ë³„ ë§¤ì¶œ ë¹„ì¤‘ (ê°€ë¡œ ëˆ„ì )")
        fig_ratio.update_layout(xaxis_tickformat=',d', legend_title="í•­ëª©")
        st.plotly_chart(fig_ratio, use_container_width=True)

        # --- [ì„¹ì…˜ B: ë¦¬í…ì…˜ ë¶„ì„ - ì ˆëŒ€ ê±´ë“¤ì§€ ì•Šì€ ê¸°ì¡´ í‹€] ---
        st.write("---")
        st.markdown("### ğŸ‘¥ ë¦¬í…ì…˜(30ì¼ ë‚´ ì‹ ê·œ ì¬ë°©ë¬¸) ë¶„ì„")
        top_room = df_final.loc[df_final['ì‹ í™˜ ì¬ë°©ë¬¸ìœ¨(%)'].idxmax(), 'ì§„ë£Œì‹¤']
        st.info(f"ğŸ’¡ ì‹ ê·œ í™˜ìì˜ 30ì¼ ì´ë‚´ ì¬ë°©ë¬¸ìœ¨ì´ ê°€ì¥ ë†’ì€ ì§„ë£Œì‹¤ì€ **{top_room}**ì…ë‹ˆë‹¤.")

        cols = st.columns(4)
        for i, room in enumerate(target_rooms):
            row = df_final[df_final['ì§„ë£Œì‹¤'] == room].iloc[0]
            with cols[i]:
                st.metric(f"ğŸ“ {room}", f"{row['ì‹ í™˜ ì¬ë°©ë¬¸ìœ¨(%)']}%", f"ì‹ ê·œì¬ë°©ë¬¸: {row['ì‹ ê·œì¬ë°©ë¬¸(ëª…)']}ëª…")

        st.write("---")
        c3, c4 = st.columns(2)
        with c3:
            st.write("#### ğŸ“ˆ ë‚´ì› êµ¬ì„± (ì‹ ê·œ vs ì‹ ê·œì¬ë°©ë¬¸)")
            st.bar_chart(df_final.set_index('ì§„ë£Œì‹¤')[['ì‹ ê·œí™˜ì(ëª…)', 'ì‹ ê·œì¬ë°©ë¬¸(ëª…)']], color=["#1e40af", "#7dd3fc"])
        with c4:
            st.write("#### ğŸ¯ ì§„ë£Œì‹¤ë³„ ì „ì²´ ëŒ€ë¹„ ê¸°ì—¬ë„ (%)")
            st.bar_chart(df_final.set_index('ì§„ë£Œì‹¤')['ì „ì²´ ëŒ€ë¹„ ê¸°ì—¬ë„(%)'], color="#0369a1")

        st.write("#### ğŸ“„ ì„¸ë¶€ ì§€í‘œ ë¶„ì„ ë°ì´í„° (ë¦¬í…ì…˜)")
        st.table(df_final[['ì§„ë£Œì‹¤', 'ì „ì²´ë‚´ì›(ê±´)', 'ì‹ ê·œí™˜ì(ëª…)', 'ì‹ ê·œì¬ë°©ë¬¸(ëª…)', 'ì‹ í™˜ ì¬ë°©ë¬¸ìœ¨(%)', 'ì „ì²´ ëŒ€ë¹„ ê¸°ì—¬ë„(%)']].set_index('ì§„ë£Œì‹¤').style.format({
            "ì „ì²´ë‚´ì›(ê±´)": "{:,}", "ì‹ ê·œí™˜ì(ëª…)": "{:,}", "ì‹ ê·œì¬ë°©ë¬¸(ëª…)": "{:,}",
            "ì‹ í™˜ ì¬ë°©ë¬¸ìœ¨(%)": "{:.1f}%", "ì „ì²´ ëŒ€ë¹„ ê¸°ì—¬ë„(%)": "{:.1f}%"
        }))

    except Exception as e:
        st.error(f"âš ï¸ ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
